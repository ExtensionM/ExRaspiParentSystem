<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: webserver_client.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: webserver_client.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var WebSocket = require('ws');
var fs = require('fs');
var rl = require("readline").createInterface(process.stdin, process.stdout);
var net = require("net");

/**
 * インスタンスを初期化します。
 * @constructor
 * @classdesc Webサーバーとの通信を管理するクラス
 */
var websocket_client = function(){
	var th = this;
	
	
	var dir_home = process.env[process.platform == "win32" ? "USERPROFILE" : "HOME"];
	/**
	 * 設定ファイルへのパス
	 */
	var setting_file_path = require("path").join(dir_home,".setting.json");
	
	/* ----- -----------------Websocket---------------- */
	
	/**
	 * WebsocketサーバーのURL
	 */
	var ws_url = "ws://ec2-52-68-77-61.ap-northeast-1.compute.amazonaws.com:3000";
	/**
	 * Webソケットクライアントのインスタンス
	 * @param {string} ws_url - WebSocketサーバーのURL
	 */
	var ws_client = new WebSocket(ws_url);
	//接続時
	ws_client.on('open',function(){
		console.log("[WEBSERVER CLIENT] [WEBSOCKET CLIENT] Connect 2 WebServer");
		choose_send(function(str){
			create_send_message(str,function(message){
				ws_client.send(message);
			});
		});
	});
	//メッセージ受け取り時
	ws_client.on('message',function(data){
		console.log("[WEBSERVER CLIENT] [WEBSOCKET CLIENT] Message Recive : " + data);
		message_parse(data);
	});
	ws_client.on('error',function(error){
		console.log("[WEBSERVER CLIENT] [WEBSOCKET CLIENT] Error : " + error.stack);
	});
	
	/**
	 * Websoketにメッセージを送信します
	 * @param {string} str - 送信する文字列
	 */
	var send_to_webserver = function(str){
		try{
			return ws_client.send(str);
		}catch(ex){
			console.log("[WEBSERVER CLIENT] [WEBSOCKET CLIENT] Error " + ex.message);
		}
	};

	//--------------------------------------------------------------
	
	/* ------------------ TCP Server And Client ----------------*/
	// Client
	/**
	 * メッセージパーサーサーバーのポート番号
	 */
	var tcp_client_port = 12000;
	/**
	 * メッセージパーサーサーバーに接続するクライアント
	 */
	var tcp_client = new net.Socket({readable:true,writable:true});

	tcp_client.on('error',function(error){
		tcp_client.connect({port:tcp_client_port});
	});	
	
	/**
	 * メッセージサーバーにメッセージを送信するよ
	 * @param {string} str - 送信する文字列
	 */
	var send_to_mpserver = function(str){
		return tcp_client.write(str);
	};
	
	/**
	 * [tcp_client]{@link tcp_client}をメッセージパーサーサーバーに接続します
	 */
	var connect_to_mpserver = function(){
		tcp_client.connect({port:tcp_client_port},function(){
			console.log("[WEBSERVER CLIENT] [TCP CLIENT] CONNECT TO MPSERVER");
		});
	};

	// Server
	/**
	 * メッセージパーサー用TCPサーバーのインスタンス
	 */
	var tcp_server_port = 10000;

	/**
	 * メッセージパーサからのクライアントを受け付けるサーバーのポート番号
	 */
	var tcp_server = new net.Server(function(socket){
		console.log("[WEBSERVER CLIENT] [TCP SERVER] CLIENT CONECTED");
		connect_to_mpserver();
		socket.on('error',function(){
			console.log("[WEBSERVER CLIENT] [TCP SERVER] SOCKET ERROR");
		});
		socket.on('data',function(str){
			send_to_webserver(str);
		});
	});
	
	tcp_server.on('error',function(){
		console.log("[WEBSERVER CLIENT] [TCP SERVER] SERVER ERROR");
	});

	/**
	 * [tcp_server]{@link tcp_server}をオープンします
	 */
	var listen_tcp_server = function(){
		tcp_server.listen(tcp_server_port,function(){
			console.log("[WEBSERVER CLIENT] [TCP SERVER] SERVER LISTEN START]");
		});
	};

	//--------------------------------------------------------------
	
	//authかloginどちらを最初に送るか判定する
	/**
	 * authかloginかどちらを最初に送るかを判定します
	 * @param {callback} callback - 設定ファイルがあれば"auth"を、なければ"login"を因数に取るcallbac	 
	 */
	var choose_send = function(callback){
		fs.exists(setting_file_path,function(exists){
			callback(exists ? "auth" : "login");
		});
	};

	/**
	 * 子機に送信するメッセージを作成します
	 * @param {string} str - "auth"か"login"か
	 * @param {callback} callback - 作られた文字列を引数に取るcallback
	 */ 
	var create_send_message = function(str,callback){
		if(str == "auth"){
			fs.readFile(setting_file_path,function(err,data){
				obj = JSON.parse(data);
				json_obj = {"type":"auth","value":{"name":obj.name,"key":obj.raskey}};
				callback(JSON.stringify(json_obj));
			});
		}else if(str == "login"){
			var user_id,user_pass;
			rl.question("Your Account ID :",function(value){ 
				user_id = value;
				rl.question("Your PassWord :",function(value){
					user_pass = value;
					json_obj = {
						"type":"regist",
								"value":{
									"name":user_id,
									"password":user_pass
									}
						};
					text = JSON.stringify(json_obj);
					callback(text);
				});
			});
		}
	}

	//サーバー側から来たメッセージを解釈
	/**
	 * サーバー側から来たメッセージを解釈します
	 * @param {string} str - Webサーバーから送られてきた文字列
	 */
	var message_parse = function(str){
		try{
			obj = JSON.parse(str);
			switch(obj["type"]){
				case "register":
					save_key(obj);
					break;
				case "login":
					check_login_result(obj);
					break;
				default:
				    send_to_mpserver(JSON.stringify(obj));
					break;
			}
		}catch(ex){
			console.log("[WEBSERVER CLIENT] [WEBSOCKET CLIENT] Message Json Parse ERROR :" + ex.stack);
		}
	};

	//鍵の保存
	/** 
	 * ログイン時に届いたWebサーバーからのキーを保存します
	 * @param {object} obj  - 届いたjsonオブジェクト
	 */
	var save_key = function(obj){
		if(obj.value.result != -1){
		var save_str = JSON.stringify({"name":obj.value.user,"raskey":obj.value.key});
			fs.writeFile(setting_file_path,save_str,function(err){
				console.log(err);
			});
		}
	};
	
	//ログインチェック
	/**
	 * ログインが成功したかどうか判定します
	 * @param {object} obj - Webサーバーから届いたjsonオブジェクト
	 */
	var check_login_result = function(obj){
		result = obj.value.result == 0 ? "LOGIN OK" : "LOGIN BAD";
		console.log("[WEBSERVER CLIENT] [WEBSOCKET CLIENT] Login Result : " + result);
		// TODO ログインに失敗した時の処理
	};

	/**
	 * TCPサーバーをスタートします
	 */
	this.start = function(){
		listen_tcp_server();
	};
	
};


module.exports = websocket_client;

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="children_client.html">children_client</a></li><li><a href="children_client-ssl_module.html">ssl_module</a></li><li><a href="children_client-tls_client.html">tls_client</a></li><li><a href="websocket_client.html">websocket_client</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Tue Jul 14 2015 16:48:44 GMT+0900 (JST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
